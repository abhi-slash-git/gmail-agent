#!/bin/sh

# Check if pushing to main branch
branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$branch" != "main" ]; then
  exit 0
fi

# Get the remote we're pushing to
remote="$1"

# Get the current local version
local_version=$(node -p "require('./package.json').version")

# Get the version from remote main (if it exists)
remote_version=$(git show "$remote/main:package.json" 2>/dev/null | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version" 2>/dev/null)

if [ -z "$remote_version" ]; then
  # No remote version found (new repo or first push)
  echo "✅ First push or new repo - skipping version check"
  exit 0
fi

if [ "$local_version" = "$remote_version" ]; then
  echo ""
  echo "⚠️  Version not bumped!"
  echo ""
  echo "   Local version:  $local_version"
  echo "   Remote version: $remote_version"
  echo ""
  echo "   To bump version, update package.json and commit."
  echo "   To skip this check, use: git push --no-verify"
  echo ""
  exit 1
fi

echo "✅ Version bumped: $remote_version → $local_version"
exit 0
